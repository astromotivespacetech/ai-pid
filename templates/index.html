<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI-Powered PI&D Tool</title>
    <link rel="stylesheet" href="/static/styles.css">
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://unpkg.com/cytoscape@3.28.1/dist/cytoscape.min.js"></script>
    <script src="https://unpkg.com/dagre@0.8.5/dist/dagre.min.js"></script>
    <script src="https://unpkg.com/cytoscape-dagre@2.5.0/cytoscape-dagre.js"></script>
    <script src="/static/pid_symbols.js?v=3"></script>
    <script src="/static/graph_viewer.js?v=5"></script>
    <style>
        body {
            display: flex;
            flex-direction: column;
            height: 100vh;
            margin: 0;
            padding: 0;
            background: var(--neutral-50);
        }

        #header {
            padding: 0.75rem 2rem;
            border-bottom: 1px solid var(--neutral-200);
            background: white;
            box-shadow: var(--shadow-sm);
            z-index: 10;
        }

        #header h1 {
            font-size: 1.5rem;
            margin: 0;
        }

        .header-content {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 1.5rem;
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            color: var(--neutral-700);
        }

        .header-links {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .header-link {
            color: var(--primary-blue);
            font-weight: 600;
            text-decoration: none;
        }

        .header-link:hover {
            text-decoration: underline;
        }

        .header-actions {
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        #help-btn {
            border: 1px solid var(--neutral-300);
            background: white;
            color: var(--neutral-900);
            border-radius: var(--radius-full);
            width: 2.5rem;
            height: 2.5rem;
            cursor: pointer;
            font-weight: 700;
            font-size: 1rem;
            transition: all var(--transition-fast);
        }

        #help-btn:hover {
            background: var(--neutral-100);
        }

        .header-text-btn {
            border: 1px solid var(--neutral-300);
            background: white;
            color: var(--neutral-900);
            border-radius: var(--radius-md);
            padding: 0.5rem 0.75rem;
            cursor: pointer;
            font-weight: 600;
            font-size: 0.875rem;
            transition: all var(--transition-fast);
            display: flex;
            align-items: center;
            gap: 0.4rem;
            white-space: nowrap;
        }

        .header-text-btn:hover {
            background: var(--neutral-100);
        }

        #main-container {
            display: flex;
            flex: 1;
            overflow: hidden;
        }

        #content-area {
            flex: 1;
            padding: 2rem;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
        }

        #chat-sidebar {
            width: 360px;
            display: flex;
            flex-direction: column;
            border-left: 1px solid var(--neutral-200);
            background: white;
            box-shadow: -4px 0 12px rgba(0,0,0,0.04);
        }

        .chat-header {
            padding: 1rem;
            border-bottom: 1px solid var(--neutral-200);
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        #chat-history {
            flex: 1;
            overflow-y: auto;
            padding: 1rem;
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
        }

        #chat-input-area {
            padding: 1rem;
            border-top: 1px solid var(--neutral-200);
            background: var(--neutral-50);
        }

        .chat-message {
            display: flex;
        }

        .message-bubble {
            padding: 0.75rem 1rem;
            border-radius: var(--radius-lg);
            max-width: 90%;
            box-shadow: var(--shadow-sm);
        }

        .message-user {
            justify-content: flex-end;
        }

        .message-user .message-bubble {
            background: var(--primary-blue);
            color: white;
            border-bottom-right-radius: 0.25rem;
        }

        .message-ai .message-bubble {
            background: white;
            color: var(--neutral-900);
            border: 1px solid var(--neutral-200);
            border-bottom-left-radius: 0.25rem;
        }

        #chat-input {
            width: 100%;
            padding: 0.75rem 1rem;
            border: 1px solid var(--neutral-300);
            border-radius: var(--radius-lg);
            font-family: inherit;
            font-size: 0.9375rem;
            resize: none;
            box-sizing: border-box;
            height: 44px;
            transition: all var(--transition-fast);
        }

        #chat-input:focus {
            outline: none;
            border-color: var(--primary-blue);
            box-shadow: 0 0 0 3px var(--primary-blue-light);
        }

        #chat-send-btn {
            width: 100%;
            margin-top: 0.75rem;
            padding: 0.75rem 1rem;
            font-weight: 600;
        }

        .login-landing {
            display: flex;
            gap: 2.5rem;
            max-width: 1200px;
            margin: 1rem auto;
            align-items: flex-start;
        }

        .login-prompt {
            padding: 2rem 2rem;
            text-align: center;
            background: white;
            border-radius: var(--radius-lg);
            box-shadow: var(--shadow-md);
            min-width: 380px;
            flex-shrink: 0;
        }

        .login-prompt h2 {
            font-size: 1.5rem;
            color: var(--neutral-900);
            margin: 0 0 0.5rem 0;
        }

        .login-prompt p {
            font-size: 0.95rem;
            color: var(--neutral-600);
            margin-bottom: 1.5rem;
            line-height: 1.5;
        }

        .landing-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            gap: 1.25rem;
        }

        .feature-section {
            background: white;
            border-radius: var(--radius-lg);
            padding: 1.25rem 1.5rem;
            box-shadow: var(--shadow-md);
        }

        .feature-section h3 {
            font-size: 1.1rem;
            color: var(--neutral-900);
            margin: 0 0 0.75rem 0;
        }

        .feature-section p {
            color: var(--neutral-700);
            line-height: 1.5;
            margin-bottom: 0.75rem;
            font-size: 0.9rem;
        }

        .example-box {
            background: var(--neutral-50);
            border: 1px solid var(--neutral-200);
            border-radius: var(--radius-md);
            padding: 0.75rem;
            margin: 0.5rem 0;
            font-family: 'Courier New', monospace;
            font-size: 0.85rem;
            color: var(--neutral-800);
            line-height: 1.4;
        }

        .feature-list {
            list-style: none;
            padding: 0;
            margin: 0.5rem 0;
        }

        .feature-list li {
            padding: 0.35rem 0;
            padding-left: 1.5rem;
            position: relative;
            color: var(--neutral-700);
            font-size: 0.9rem;
            line-height: 1.4;
        }

        .feature-list li:before {
            content: "âœ“";
            position: absolute;
            left: 0;
            color: var(--primary-blue);
            font-weight: bold;
        }

        .signin-buttons {
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
            align-items: center;
        }

        .signin-btn {
            display: inline-flex;
            align-items: center;
            gap: 0.75rem;
            padding: 0.75rem 1.5rem;
            border-radius: 6px;
            font-family: 'Roboto', -apple-system, BlinkMacSystemFont, sans-serif;
            font-size: 1rem;
            font-weight: 600;
            text-decoration: none;
            transition: all 0.15s ease;
            box-shadow: 0 1px 2px rgba(0, 0, 0, 0.05);
            min-width: 240px;
            justify-content: center;
        }

        .signin-btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.12);
        }

        .signin-btn:active {
            transform: translateY(0);
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.12);
        }

        .signin-btn.google {
            background: white;
            color: #3c4043;
            border: 1px solid #dadce0;
        }

        .signin-btn.google:hover {
            background: #f8f9fa;
            border-color: #d2d4d6;
        }

        .signin-btn.github {
            background: white;
            color: #24292e;
            border: 1px solid #dadce0;
        }

        .signin-btn.github:hover {
            background: #f8f9fa;
            border-color: #d2d4d6;
        }

        .signin-logo {
            width: 20px;
            height: 20px;
            flex-shrink: 0;
        }

        #graph-container {
            flex: 1;
            border: 1px solid var(--neutral-200);
            background: white;
            border-radius: 0 0 var(--radius-xl) var(--radius-xl);
            box-shadow: var(--shadow-md);
            overflow: hidden;
        }

        .graph-controls {
            padding: 1rem;
            background: white;
            border: 1px solid var(--neutral-200);
            border-radius: var(--radius-lg);
            display: flex;
            flex-wrap: wrap;
            gap: 0.75rem;
            align-items: center;
            box-shadow: var(--shadow-sm);
        }

        .graph-controls button {
            margin: 0;
            padding: 0.5rem 1rem;
        }

        .graph-controls select {
            padding: 0.5rem 1rem;
            border-radius: var(--radius-md);
            border: 1px solid var(--neutral-300);
            font-size: 0.875rem;
            cursor: pointer;
            background: white;
            min-width: 180px;
        }

        #save-area {
            display: flex;
            justify-content: flex-end;
        }

        #save-area button {
            padding: 0.75rem 1.5rem;
            font-weight: 600;
            box-shadow: var(--shadow-md);
        }

        .error-message {
            color: var(--error);
            padding: 1rem 1.25rem;
            background: var(--error-bg);
            border-radius: var(--radius-lg);
            border: 1px solid var(--error);
            margin-bottom: 1.25rem;
            animation: slideDown 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .error-message strong {
            font-weight: 600;
        }

        .modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.6);
            backdrop-filter: blur(4px);
            z-index: 1000;
            align-items: center;
            justify-content: center;
            animation: fadeIn 0.2s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .modal-content {
            background: white;
            border-radius: var(--radius-xl);
            padding: 2rem;
            max-width: 650px;
            max-height: 85vh;
            overflow-y: auto;
            box-shadow: var(--shadow-xl);
            animation: slideUp 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
            padding-bottom: 1rem;
            border-bottom: 1px solid var(--neutral-200);
        }

        .modal-header h2 {
            margin: 0;
        }

        .modal-close {
            background: none;
            border: none;
            font-size: 1.75rem;
            cursor: pointer;
            color: var(--neutral-500);
            padding: 0;
            width: 2rem;
            height: 2rem;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: var(--radius-md);
            transition: all var(--transition-fast);
        }

        .modal-close:hover {
            background: var(--neutral-100);
            color: var(--neutral-900);
        }

        .modal-body {
            color: var(--neutral-700);
            line-height: 1.7;
        }

        .modal-body h3 {
            color: var(--neutral-900);
            font-size: 1.125rem;
            margin-top: 1.5rem;
            margin-bottom: 0.75rem;
        }

        .modal-body p {
            margin-bottom: 1rem;
        }

        .modal-body ul {
            margin: 0.75rem 0;
            padding-left: 1.5rem;
        }

        .modal-body li {
            margin-bottom: 0.5rem;
        }

        .modal-body strong {
            color: var(--neutral-900);
            font-weight: 600;
        }
    </style>
</head>
<body>
    <div id="header">
        <div class="header-content">
            <div style="display: flex; align-items: center; gap: 2rem; flex: 1;">
                <a href="/" style="text-decoration: none; color: inherit;">
                    <h1 style="margin: 0; white-space: nowrap; cursor: pointer;">AI-Powered Text-to-PI&D Tool</h1>
                </a>
                {% if user %}
                <div class="user-info">
                    <span>Signed in as <strong>{{ user.display_name or user.email or user.username }}</strong></span>
                    <span style="color: var(--neutral-400);">|</span>
                    <div class="header-links">
                        <a href="/my-graphs" class="header-link">My Graphs</a>
                        <a href="/logout" class="header-link">Logout</a>
                    </div>
                </div>
                {% endif %}
            </div>
            <div class="header-actions">
                <button id="symbol-browser-btn" class="header-text-btn" title="Browse Symbols">
                    <span style="font-size: 1rem;">â—†</span>
                    <span>Symbol Library</span>
                </button>
                <button id="help-btn" title="Help">?</button>
            </div>
        </div>
    </div>

    <div id="main-container">
        <div id="content-area">
            {% if not user and not is_demo %}
            {% set google_enabled = providers.get('google') if providers else False %}
            {% set github_enabled = providers.get('github') if providers else False %}
            <div class="login-landing">
                <!-- Left Column: Login + Perfect For -->
                <div style="display: flex; flex-direction: column; gap: 1.25rem; min-width: 380px; flex-shrink: 0;">
                    <div class="login-prompt">
                        <h2>Get Started</h2>
                        <p>Sign in to start creating P&ID diagrams with AI</p>
                        <div class="signin-buttons">
                            {% if google_enabled %}
                            <a class="signin-btn google" href="/login/google">
                                <svg class="signin-logo" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                                    <path d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z" fill="#4285F4"/>
                                    <path d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z" fill="#34A853"/>
                                    <path d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z" fill="#FBBC05"/>
                                    <path d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z" fill="#EA4335"/>
                                </svg>
                                Sign in with Google
                            </a>
                            {% endif %}
                            {% if github_enabled %}
                            <a class="signin-btn github" href="/login/github">
                                <svg class="signin-logo" viewBox="0 0 24 24" aria-hidden="true" xmlns="http://www.w3.org/2000/svg">
                                    <path fill-rule="evenodd" clip-rule="evenodd" d="M12 1.5C6.2 1.5 1.5 6.2 1.5 12c0 4.65 3.02 8.6 7.21 9.99.53.1.72-.23.72-.5 0-.25-.01-.92-.01-1.8-2.94.64-3.56-1.42-3.56-1.42-.48-1.22-1.17-1.54-1.17-1.54-.96-.65.07-.64.07-.64 1.06.08 1.62 1.1 1.62 1.1.95 1.62 2.48 1.15 3.09.88.1-.69.37-1.15.67-1.42-2.35-.27-4.82-1.18-4.82-5.24 0-1.16.41-2.1 1.09-2.84-.11-.27-.47-1.36.1-2.83 0 0 .88-.28 2.9 1.08a9.97 9.97 0 0 1 5.28 0c2.02-1.36 2.9-1.08 2.9-1.08.57 1.47.21 2.56.1 2.83.68.74 1.09 1.68 1.09 2.84 0 4.07-2.48 4.97-4.84 5.23.38.33.72.97.72 1.96 0 1.42-.01 2.57-.01 2.92 0 .27.19.61.73.5A10.53 10.53 0 0 0 22.5 12c0-5.8-4.7-10.5-10.5-10.5Z" fill="currentColor"/>
                                </svg>
                                Continue with GitHub
                            </a>
                            {% endif %}
                        </div>
                        <p style="font-size: 0.85rem; color: var(--neutral-600); margin-top: 0.75rem; text-align: center;">
                            or <a href="/demo" style="color: var(--primary-blue); font-weight: 600; text-decoration: none;">Try Demo â†’</a>
                        </p>
                    </div>

                    <div class="feature-section">
                        <h3>ðŸ’¡ Perfect For</h3>
                        <ul class="feature-list">
                            <li>Process & chemical engineers drafting system designs</li>
                            <li>Engineering students learning P&ID conventions</li>
                            <li>Technical documentation and proposals</li>
                            <li>Rapid prototyping and concept validation</li>
                        </ul>
                    </div>
                </div>

                <!-- Right Column: How It Works + Features -->
                <div class="landing-content">
                    <div class="feature-section">
                        <h3>ðŸš€ How It Works</h3>
                        <p>Describe your process system in plain English:</p>
                        <div class="example-box">
                            "Centrifugal pump feeds water through a control valve to a heat exchanger, then to a storage tank"
                        </div>
                        <p style="font-size: 0.85rem; color: var(--neutral-600); margin-top: 0.5rem;">â†’ Instant diagram with proper symbols and layout</p>
                    </div>

                    <div class="feature-section">
                        <h3>âœ¨ Features</h3>
                        <ul class="feature-list">
                            <li><strong>250+ Engineering Symbols</strong> - <a href="javascript:openSymbolBrowser()" style="color: var(--primary-blue); text-decoration: underline; cursor: pointer;">Browse â†’</a> Pumps, valves, heat exchangers, tanks</li>
                            <li><strong>Smart Auto-Matching</strong> - AI selects the right symbols</li>
                            <li><strong>Custom Icons</strong> - Upload your own specialized symbols</li>
                            <li><strong>Interactive Editing</strong> - Drag nodes and customize layouts</li>
                            <li><strong>Iterative Refinement</strong> - Chat to add or modify components</li>
                        </ul>
                    </div>
                </div>
            </div>
            {% else %}
                {% if error %}
                <div class="error-message">
                    <strong>Error:</strong> {{ error }}
                </div>
                {% endif %}

                {% if is_demo %}
                <div style="padding: 0.75rem 1.5rem; background: linear-gradient(135deg, #fbbf24 0%, #f59e0b 100%); border-bottom: 1px solid #d97706; text-align: center; color: white; font-weight: 600; font-size: 0.95rem; border-radius: var(--radius-xl) var(--radius-xl) 0 0;">
                    ðŸŽ¯ Demo Mode â€¢ Changes won't be saved â€¢ <a href="/" style="color: white; text-decoration: underline; font-weight: 700;">Sign in</a> to save your diagrams
                </div>
                {% endif %}

                <!-- Hidden form inputs for saving -->
                <input type="hidden" id="graph-id-input" value="{{ graph_id or '' }}">
                <input type="hidden" id="filename-base-input" value="{{ filename_base or '' }}">
                <input type="hidden" id="instruction-input" value="{{ instruction or '' }}">
                <input type="hidden" id="is-demo" value="{{ 'true' if is_demo else 'false' }}">
                <input type="hidden" id="nodes-input" value="">
                <input type="hidden" id="edges-input" value="">

                <script id="node-data-json" type="application/json">{{ (nodes or []) | tojson }}</script>
                <script id="edge-data-json" type="application/json">{{ (edges or []) | tojson }}</script>

                <div id="graph-container" style="display: {% if nodes or edges %}block{% else %}none{% endif %}; flex: 1; width: 100%; position: relative;">
                    <div id="version-indicator" style="position: absolute; top: 1rem; left: 1rem; padding: 0.375rem 0.75rem; background: rgba(59, 130, 246, 0.15); border-radius: var(--radius-md); font-size: 0.75rem; color: var(--primary-blue); font-weight: 500; display: none; z-index: 10; transition: background 0.2s; white-space: nowrap; max-width: 400px; overflow: hidden; text-overflow: ellipsis; display: flex; align-items: center; gap: 0.25rem;">
                        <span id="version-number" onclick="openVersionHistory()" style="cursor: pointer;">v1</span>
                        <span id="version-date" onclick="openVersionHistory()" style="opacity: 0.8; margin: 0 0.25rem; cursor: pointer;"></span>
                        <span id="version-description" onclick="openVersionHistory()" style="opacity: 0.7; cursor: pointer;"></span>
                        <button id="edit-version-btn" style="background: none; border: none; padding: 0; margin: 0; cursor: pointer; display: none; color: var(--primary-blue); line-height: 1; vertical-align: middle;">
                            <i data-lucide="edit-2" style="width: 14px; height: 14px;"></i>
                        </button>
                    </div>
                </div>
                
                <!-- Controls and Inspector Row -->
                <div id="controls-inspector-row" style="display: {% if nodes or edges %}flex{% else %}none{% endif %}; gap: 1rem; margin-top: 1rem; align-items: flex-start;">
                    <!-- Graph Controls -->
                    <div id="graph-controls" style="display: flex; gap: 0.5rem; align-items: center;">
                        <button id="layout-btn" class="secondary" style="padding: 0.375rem 0.5rem; display: flex; align-items: center; gap: 0.5rem;">
                            <i data-lucide="maximize-2" style="width: 16px; height: 16px;"></i>
                        </button>
                        <button id="center-btn" class="secondary" style="padding: 0.375rem 0.5rem; display: flex; align-items: center; gap: 0.5rem;">
                            <i data-lucide="crosshair" style="width: 16px; height: 16px;"></i>
                        </button>
                        <button id="zoom-in-btn" class="secondary" style="padding: 0.375rem 0.5rem; display: flex; align-items: center; gap: 0.5rem;">
                            <i data-lucide="zoom-in" style="width: 16px; height: 16px;"></i>
                        </button>
                        <button id="zoom-out-btn" class="secondary" style="padding: 0.375rem 0.5rem; display: flex; align-items: center; gap: 0.5rem;">
                            <i data-lucide="zoom-out" style="width: 16px; height: 16px;"></i>
                        </button>
                        <button id="save-btn" class="secondary" style="padding: 0.375rem 0.5rem; display: flex; align-items: center; gap: 0.5rem;" onclick="saveGraphAjax()" {% if is_demo %}disabled style="opacity: 0.5; cursor: not-allowed;"{% endif %} title="{% if is_demo %}Sign in to save diagrams{% else %}Save diagram{% endif %}">
                            <i data-lucide="save" style="width: 16px; height: 16px;"></i>
                        </button>
                        <div style="position: relative;">
                            <button id="export-btn" class="secondary" style="padding: 0.375rem 0.5rem; display: flex; align-items: center; gap: 0.5rem;" title="Export">
                                <i data-lucide="download" style="width: 16px; height: 16px;"></i>
                            </button>
                            <div id="export-menu" style="display: none; position: absolute; top: 100%; right: 0; margin-top: 0.25rem; background: white; border: 1px solid var(--neutral-300); border-radius: var(--radius-md); box-shadow: var(--shadow-lg); min-width: 140px; z-index: 1000;">
                                <button id="export-png-option" style="width: 100%; padding: 0.5rem 0.75rem; text-align: left; border: none; background: none; cursor: pointer; font-size: 0.875rem; display: flex; align-items: center; gap: 0.5rem; color: var(--neutral-900);">
                                    <i data-lucide="image" style="width: 14px; height: 14px;"></i>
                                    Export PNG
                                </button>
                                <button id="export-svg-option" style="width: 100%; padding: 0.5rem 0.75rem; text-align: left; border: none; background: none; cursor: pointer; font-size: 0.875rem; display: flex; align-items: center; gap: 0.5rem; color: var(--neutral-900);">
                                    <i data-lucide="file-image" style="width: 14px; height: 14px;"></i>
                                    Export SVG
                                </button>
                            </div>
                        </div>
                    </div>

                </div>
                
                <script id="node-data-json" type="application/json">{{ (nodes or []) | tojson }}</script>
                <script id="edge-data-json" type="application/json">{{ (edges or []) | tojson }}</script>
            {% endif %}
        </div>

        {% if user %}
        <div id="chat-sidebar">
            <div class="chat-header">
                <strong>Chat</strong>
                <button id="clear-chat-btn" class="danger small" onclick="clearChat()">Clear</button>
            </div>
            <div id="chat-history"></div>
            <div id="chat-input-area">
                <textarea id="chat-input" placeholder="Describe your system... (Press Enter to send)"></textarea>
            </div>
        </div>
        {% elif is_demo %}
        <div id="chat-sidebar">
            <div class="chat-header">
                <strong>Chat</strong>
                <button id="clear-chat-btn" class="danger small" onclick="clearChat()" disabled style="opacity: 0.5; cursor: not-allowed;">Clear</button>
            </div>
            <div id="chat-history">
                <div class="chat-message message-assistant">
                    <div class="message-bubble">Welcome to the demo! This cooling water system includes a centrifugal pump, pressure relief valve, heat exchanger, check valve, storage tank, and level indicator. Sign in to edit and refine this diagram using chat.</div>
                </div>
            </div>
            <div id="chat-input-area" style="opacity: 0.6; pointer-events: none;">
                <textarea id="chat-input" placeholder="Sign in to refine your diagram..." disabled></textarea>
            </div>
        </div>
        {% endif %}
    </div>

    <!-- Version History Modal -->
    <div id="version-history-modal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.5); z-index: 2000; flex-direction: column; justify-content: center; align-items: center; padding: 2rem;">
        <div style="background: white; border-radius: var(--radius-lg); box-shadow: var(--shadow-xl); width: 90%; max-width: 700px; max-height: 85vh; display: flex; flex-direction: column; overflow: hidden;">
            <div style="padding: 1.5rem; border-bottom: 1px solid var(--neutral-200); display: flex; align-items: center; justify-content: space-between;">
                <div>
                    <h2 style="margin: 0; font-size: 1.3rem; font-weight: 600;">Version History</h2>
                    <p style="margin: 0.25rem 0 0 0; font-size: 0.85rem; color: var(--neutral-500);">Restore to a previous version</p>
                </div>
                <button id="close-history-btn" style="border: none; background: none; cursor: pointer; font-size: 1.5rem; color: var(--neutral-600);" title="Close">âœ•</button>
            </div>
            <div style="flex: 1; overflow-y: auto; padding: 1.5rem;">
                <div id="version-list" style="display: flex; flex-direction: column; gap: 0.75rem;">
                    <!-- Versions will be populated here -->
                </div>
                <div id="version-loading" style="display: none; text-align: center; padding: 2rem; color: var(--neutral-500);">
                    <p>Loading versions...</p>
                </div>
                <div id="version-empty" style="display: none; text-align: center; padding: 2rem; color: var(--neutral-500);">
                    <p>No saved versions yet. Versions are created each time you save.</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Floating Edit Icon (appears on node selection) -->
    <div id="floating-edit-btn" style="position: fixed; background: #EFF6FF; color: #3B82F6; border-radius: 6px; width: 28px; height: 28px; cursor: pointer; z-index: 9999; transition: all 0.2s ease; display: none; align-items: center; justify-content: center; border: 1px solid #DBEAFE;" title="Edit Symbol">
        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M17 3a2.828 2.828 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5L17 3z"></path></svg>
    </div>

    <!-- Symbol Browser Modal -->
    <div id="symbol-browser-modal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.5); z-index: 2000; flex-direction: column; justify-content: center; align-items: center; padding: 2rem;">
        <div style="background: white; border-radius: var(--radius-lg); box-shadow: var(--shadow-xl); width: 90%; max-width: 900px; max-height: 85vh; display: flex; flex-direction: column; overflow: hidden;">
            <!-- Header -->
            <div style="padding: 1.5rem; border-bottom: 1px solid var(--neutral-200); display: flex; align-items: center; justify-content: space-between; gap: 1rem;">
                <div style="display: flex; align-items: center; gap: 0.75rem; flex: 1;">
                    <h2 style="margin: 0; font-size: 1.3rem; font-weight: 600;">Symbol Library</h2>
                    <span style="font-size: 0.85rem; color: var(--neutral-500);">250+ engineering symbols</span>
                </div>
                <button id="close-browser-btn" style="border: none; background: none; cursor: pointer; font-size: 1.5rem; color: var(--neutral-600);" title="Close">âœ•</button>
            </div>

            <!-- Search Bar -->
            <div style="padding: 1rem 1.5rem; border-bottom: 1px solid var(--neutral-200); background: var(--neutral-50);">
                <input id="symbol-search" type="text" placeholder="Search symbols (e.g., pump, valve, heat exchanger)..." style="width: 100%; padding: 0.75rem 1rem; font-size: 0.95rem; border: 1px solid var(--neutral-300); border-radius: var(--radius-md); font-family: inherit;">
            </div>

            <!-- Symbols Grid -->
            <div style="flex: 1; overflow-y: auto; padding: 1.5rem;">
                <!-- Upload Custom Symbol -->
                <div style="margin-bottom: 1.5rem; padding: 1rem; border: 2px dashed var(--neutral-300); border-radius: var(--radius-lg); background: var(--neutral-50); text-align: center;">
                    <label for="symbol-library-upload" style="display: inline-block; cursor: pointer; padding: 0.75rem 1.5rem; background: var(--primary-blue); color: white; border-radius: var(--radius-md); font-weight: 600; font-size: 0.9375rem; transition: all var(--transition-fast);">
                        ðŸ“¤ Upload Custom Symbol
                    </label>
                    <input id="symbol-library-upload" type="file" accept="image/png,image/jpeg,image/jpg,image/svg+xml" style="display: none;">
                    <p style="margin: 0.5rem 0 0 0; font-size: 0.8125rem; color: var(--neutral-600);">Upload your own PNG, JPG, or SVG</p>
                </div>
                
                <div id="symbol-grid" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(100px, 1fr)); gap: 1rem;">
                    <!-- Symbols will be populated here -->
                </div>
                <div id="symbol-no-results" style="display: none; text-align: center; padding: 2rem; color: var(--neutral-500);">
                    <p style="font-size: 1rem; margin: 0;">No symbols found</p>
                </div>
            </div>
        </div>
    </div>

    <style>
        /* Node selection highlighting */
        node.selected {
            border-width: 3px !important;
            border-color: #3B82F6 !important;
            border-style: solid !important;
        }

        /* Floating edit icon */
        #floating-edit-btn:hover {
            background: #DBEAFE;
            border-color: #BFDBFE;
        }

        #floating-edit-btn:active {
            background: #BFDBFE;
            transform: scale(0.95);
        }

        .symbol-browser-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 0.5rem;
            padding: 0.75rem;
            border: 1px solid var(--neutral-200);
            border-radius: var(--radius-md);
            background: white;
            cursor: pointer;
            transition: all var(--transition-fast);
            text-align: center;
        }

        .symbol-browser-item:hover {
            border-color: var(--primary-blue);
            background: var(--primary-blue);
            color: white;
            transform: translateY(-2px);
            box-shadow: var(--shadow-md);
        }

        .symbol-image {
            width: 60px;
            height: 60px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: var(--neutral-50);
            border-radius: var(--radius-md);
            padding: 0.5rem;
        }

        .symbol-browser-item:hover .symbol-image {
            background: rgba(255, 255, 255, 0.2);
        }

        .symbol-image img {
            max-width: 100%;
            max-height: 100%;
            object-fit: contain;
        }

        .symbol-name {
            font-size: 0.75rem;
            font-weight: 600;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
            width: 100%;
        }

        .symbol-category {
            font-size: 0.65rem;
            opacity: 0.7;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
            width: 100%;
        }

        .version-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0.625rem 0.75rem;
            border: 1px solid var(--neutral-200);
            border-radius: var(--radius-md);
            background: white;
            transition: all var(--transition-fast);
        }

        .version-item:hover {
            border-color: var(--neutral-300);
            background: var(--neutral-50);
        }

        .version-item.current {
            border-color: var(--primary-blue);
            background: rgba(59, 130, 246, 0.05);
        }

        .version-info {
            flex: 1;
        }

        .version-number {
            font-weight: 600;
            font-size: 0.85rem;
            color: var(--neutral-900);
        }

        .version-time {
            font-size: 0.75rem;
            color: var(--neutral-600);
            margin-top: 0.125rem;
        }

        .version-instruction {
            font-size: 0.7rem;
            color: var(--neutral-500);
            margin-top: 0.125rem;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }
    </style>

    <script>
        let cy;
        let nodeData = JSON.parse(document.getElementById('node-data-json')?.textContent || '[]');
        let edgeData = JSON.parse(document.getElementById('edge-data-json')?.textContent || '[]');
        let conversationHistory = [];
        let currentVersionNumber = null;  // Track which version is currently loaded
        
        console.log('Page load - nodeData:', nodeData, 'edgeData:', edgeData);

        // If we're on a fresh page with no graph data, clear the conversation
        if (nodeData.length === 0 && edgeData.length === 0) {
            localStorage.removeItem('pidConversationHistory');
            console.log('Cleared conversation history for fresh start');
        } else {
            // A graph is loaded - show version indicator
            const graphIdInput = document.getElementById('graph-id-input');
            if (graphIdInput && graphIdInput.value) {
                // Check if a specific version was loaded
                const loadedVersion = sessionStorage.getItem('loadedVersionNumber');
                console.log('Loaded version from sessionStorage:', loadedVersion);
                if (loadedVersion) {
                    console.log('Setting version indicator to:', loadedVersion);
                    setVersionIndicator(parseInt(loadedVersion));
                    sessionStorage.removeItem('loadedVersionNumber');  // Clear so it doesn't stick
                } else {
                    // No specific version loaded - fetch latest version number to display
                    fetch(`/api/graphs/${graphIdInput.value}/versions`)
                        .then(res => res.json())
                        .then(data => {
                            if (data.versions && data.versions.length > 0) {
                                const latestVersionNum = data.versions[0].version_number;
                                setVersionIndicator(latestVersionNum);
                            }
                        })
                        .catch(err => console.error('Failed to fetch version info:', err));
                }
            }
        }

        // Load conversation history from localStorage
        function loadConversationHistory() {
            const saved = localStorage.getItem('pidConversationHistory');
            if (saved) {
                try {
                    conversationHistory = JSON.parse(saved);
                    renderChatHistory();
                } catch (e) {
                    conversationHistory = [];
                }
            }
        }

        // Save conversation history to localStorage
        function saveConversationHistory() {
            localStorage.setItem('pidConversationHistory', JSON.stringify(conversationHistory));
        }

        // Render chat history to the chat display
        function renderChatHistory() {
            const chatHistory = document.getElementById('chat-history');
            if (!chatHistory) return;
            
            chatHistory.innerHTML = '';
            conversationHistory.forEach(msg => {
                const div = document.createElement('div');
                div.className = `chat-message message-${msg.role}`;
                div.innerHTML = `<div class="message-bubble">${escapeHtml(msg.content)}</div>`;
                chatHistory.appendChild(div);
            });
            
            // Scroll to bottom
            chatHistory.scrollTop = chatHistory.scrollHeight;
        }

        // Escape HTML to prevent XSS
        function escapeHtml(text) {
            const map = {
                '&': '&amp;',
                '<': '&lt;',
                '>': '&gt;',
                '"': '&quot;',
                "'": '&#039;'
            };
            return text.replace(/[&<>"']/g, m => map[m]);
        }

        // Add message to chat and save
        function addMessage(role, content) {
            conversationHistory.push({ role, content });
            saveConversationHistory();
            renderChatHistory();
        }

        // Clear chat history
        function clearChat() {
            if (confirm('Are you sure you want to clear the chat history?')) {
                conversationHistory = [];
                saveConversationHistory();
                renderChatHistory();
            }
        }


        // Send chat message to backend
        async function sendMessage() {
            const input = document.getElementById('chat-input');
            const message = input.value.trim();
            
            if (!message) return;
            
            // Add user message to chat
            addMessage('user', message);
            input.value = '';
            input.style.height = '40px'; // Reset height
            
            // Add loading indicator
            const chatHistory = document.getElementById('chat-history');
            const loadingDiv = document.createElement('div');
            loadingDiv.className = 'chat-message message-ai';
            loadingDiv.innerHTML = '<div class="message-bubble">Generating PI&D...</div>';
            loadingDiv.id = 'loading-indicator';
            chatHistory.appendChild(loadingDiv);
            chatHistory.scrollTop = chatHistory.scrollHeight;
            
            try {
                const response = await fetch('/chat', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        message: message,
                        history: conversationHistory.slice(0, -1) // Exclude the just-added user message
                    })
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}`);
                }
                
                const data = await response.json();
                
                // Remove loading indicator
                const loading = document.getElementById('loading-indicator');
                if (loading) loading.remove();
                
                // Add AI response to chat
                addMessage('ai', data.response);
                
                // Update graph if nodes/edges are provided
                if (data.nodes && data.edges && data.nodes.length > 0) {
                    console.log('Updating graph with nodes:', data.nodes, 'edges:', data.edges);
                    updateGraph(data.nodes, data.edges, data.filename_base, data.instruction);
                } else {
                    console.log('No graph data in response:', data);
                }
            } catch (error) {
                // Remove loading indicator
                const loading = document.getElementById('loading-indicator');
                if (loading) loading.remove();
                
                const errorMsg = `Error: ${error.message}`;
                addMessage('ai', errorMsg);
                console.error('Chat error:', error);
            }
        }

        // Update the graph with new data
        function updateGraph(nodes, edges, filename_base = null, instruction = null) {
            // Clear version indicator for new graphs from chat
            clearVersionIndicator();
            
            // Clear saved node positions for new graphs so they get properly laid out
            localStorage.removeItem('graphNodePositions');
            
            // Make sure graph container and controls are visible
            const graphContainer = document.getElementById('graph-container');
            const controlsInspectorRow = document.getElementById('controls-inspector-row');
            const graphControls = document.getElementById('graph-controls-area');
            const saveArea = document.getElementById('save-area');
            
            if (graphContainer) {
                graphContainer.style.display = 'block';
            }
            if (controlsInspectorRow) {
                controlsInspectorRow.style.display = 'flex';
            }
            if (graphControls) {
                graphControls.style.display = 'block';
            }
            if (saveArea) {
                saveArea.style.display = 'block';
                // Update save form with current data
                const filenameInput = document.getElementById('filename-base-input');
                const instructionInput = document.getElementById('instruction-input');
                const nodesInput = document.getElementById('nodes-input');
                const edgesInput = document.getElementById('edges-input');
                if (filenameInput && filename_base) {
                    filenameInput.value = filename_base || '';
                }
                if (instructionInput && instruction) {
                    instructionInput.value = instruction || '';
                }
                if (nodesInput && nodes) {
                    // Filter out undefined values
                    const cleanNodes = nodes.filter(n => n !== undefined && n !== null);
                    nodesInput.value = JSON.stringify(cleanNodes);
                }
                if (edgesInput && edges) {
                    // Convert edge tuples to objects for saving and filter out undefined
                    const edgeObjects = edges.filter(e => e !== undefined && e !== null).map(e => {
                        if (Array.isArray(e)) {
                            return { source: e[0], target: e[1] };
                        }
                        return e;
                    });
                    edgesInput.value = JSON.stringify(edgeObjects);
                }
            }
            
            // Update nodeData for customize symbols to work
            nodeData = nodes;
            
            if (!cy) {
                // Initialize graph and capture instance
                initGraphViewer('graph-container', nodes, edges).then((instance) => {
                    cy = instance;
                    
                    // Restore custom imageUrl for nodes if available
                    nodes.forEach(node => {
                        if (typeof node === 'object' && node.imageUrl) {
                            const cyNode = cy.getElementById(node.id);
                            if (cyNode && cyNode.length > 0) {
                                cyNode.data('imageUrl', node.imageUrl);
                            }
                        }
                    });
                    
                    // Apply default left-to-right layout
                    setTimeout(() => {
                        applyDefaultLayout();
                    }, 100);
                    
                    // Node inspector uses live selection; no bulk population needed
                }).catch(err => {
                    console.error('Failed to initialize graph:', err);
                });
            } else {
                // Update existing graph
                cy.elements().remove();

                // Normalize nodes to {id,label,imageUrl,position}
                const normalizedNodes = (nodes || [])
                    .map(n => typeof n === 'string' ? { id: n, label: n, imageUrl: null, position: null } : { id: n?.id, label: n?.label || n?.id, imageUrl: n?.imageUrl || null, position: n?.position })
                    .filter(n => n.id);

                // Add new nodes
                normalizedNodes.forEach(n => {
                    const nodeData = { data: { id: n.id, label: n.label, imageUrl: n.imageUrl || null } };
                    if (n.position) {
                        nodeData.position = n.position;
                    }
                    cy.add(nodeData);
                });

                // Convert edges to proper format and add them
                (edges || []).forEach(edge => {
                    let source, target;
                    if (Array.isArray(edge)) {
                        // Tuple format [source, target]
                        [source, target] = edge;
                    } else if (typeof edge === 'object') {
                        // Object format {source, target}
                        source = edge.source;
                        target = edge.target;
                    }
                    
                    if (source && target) {
                        cy.add({ 
                            data: { 
                                id: `${source}-${target}`,
                                source: source, 
                                target: target 
                            } 
                        });
                    }
                });

                // Apply imageUrl via fuzzy style if not already provided
                normalizedNodes.forEach(async (n) => {
                    const node = cy.getElementById(n.id);
                    if (!node || node.length === 0) return;
                    if (n.imageUrl) {
                        node.data('imageUrl', n.imageUrl);
                    } else {
                        try {
                            const style = await getNodeStyle(n.id);
                            if (style && style.backgroundImage) {
                                node.data('imageUrl', style.backgroundImage);
                            }
                        } catch (e) {
                            console.warn('Could not resolve style for node', n.id, e);
                        }
                    }
                });
                
                // Apply default left-to-right layout for updated graphs
                applyDefaultLayout();
                // Node inspector uses live selection; no bulk population needed
            }
        }

        document.addEventListener('DOMContentLoaded', async function() {
            // Ensure symbols are loaded first
            await ensureSymbolsLoaded();
            
            // Load chat history
            loadConversationHistory();
            
            // Setup chat input handlers
            const chatInput = document.getElementById('chat-input');
            
            if (chatInput) {
                // Auto-grow textarea
                chatInput.addEventListener('input', function() {
                    this.style.height = 'auto';
                    this.style.height = Math.min(this.scrollHeight, 120) + 'px';
                });
                
                // Send on Enter (but not Shift+Enter for multi-line)
                chatInput.addEventListener('keydown', function(e) {
                    if (e.key === 'Enter' && !e.shiftKey) {
                        e.preventDefault();
                        sendMessage();
                    }
                });
            }
            
            // Initialize graph if nodes exist
            if (nodeData && nodeData.length > 0) {
                // For demo mode, always clear saved positions to get fresh layout
                const isDemoMode = document.getElementById('is-demo')?.value === 'true';
                if (isDemoMode) {
                    localStorage.removeItem('graphNodePositions');
                }
                
                cy = await initGraphViewer('graph-container', nodeData, edgeData);
                // Always apply default Lâ†’R layout
                setTimeout(() => {
                    applyDefaultLayout();
                }, 100);
            }

            // Initialize Lucide icons
            if (typeof lucide !== 'undefined') {
                lucide.createIcons();
            }
        });
        
        function applyLayout(layoutType) {
            if (!cy) return;
            
            let layoutConfig = {
                animate: true,
                animationDuration: 500,
                fit: true,
                padding: 50
            };
            
            switch(layoutType) {
                case 'dagre-lr':
                    layoutConfig.name = 'dagre';
                    layoutConfig.rankDir = 'LR';
                    layoutConfig.nodeSep = 80;
                    layoutConfig.rankSep = 120;
                    layoutConfig.edgeSep = 20;
                    layoutConfig.ranker = 'network-simplex';
                    break;
                case 'dagre-tb':
                    layoutConfig.name = 'dagre';
                    layoutConfig.rankDir = 'TB';
                    layoutConfig.nodeSep = 80;
                    layoutConfig.rankSep = 120;
                    layoutConfig.edgeSep = 20;
                    layoutConfig.ranker = 'network-simplex';
                    break;
                case 'breadthfirst':
                    layoutConfig.name = 'breadthfirst';
                    layoutConfig.directed = true;
                    layoutConfig.spacingFactor = 1.5;
                    break;
                case 'circle':
                    layoutConfig.name = 'circle';
                    layoutConfig.spacingFactor = 1.5;
                    break;
                case 'grid':
                    layoutConfig.name = 'grid';
                    layoutConfig.spacingFactor = 1.5;
                    break;
                case 'cose':
                    layoutConfig.name = 'cose';
                    layoutConfig.nodeRepulsion = 8000;
                    layoutConfig.idealEdgeLength = 100;
                    layoutConfig.numIter = 1000;
                    break;
            }
            
            cy.layout(layoutConfig).run();
        }
        
        // Apply default Lâ†’R layout
        function applyDefaultLayout() {
            if (!cy) return;
            const layoutConfig = {
                name: 'dagre',
                rankDir: 'LR',
                nodeSep: 80,
                rankSep: 120,
                edgeSep: 20,
                ranker: 'network-simplex',
                animate: true,
                animationDuration: 500,
                fit: true,
                padding: 50
            };
            cy.layout(layoutConfig).run();
        }
        
        // Node selection with floating edit button
        let selectedNodeId = null;
        
        // Update floating button position based on current viewport
        function updateFloatingButtonPosition() {
            if (!selectedNodeId || !cy) return;
            
            const floatingBtn = document.getElementById('floating-edit-btn');
            if (!floatingBtn) return;
            
            const node = cy.getElementById(selectedNodeId);
            if (!node || node.empty()) return;
            
            // Get the rendered bounding box (includes underlay/selection styling)
            const bbox = node.renderedBoundingBox();
            const cy_container = document.getElementById('graph-container');
            const rect = cy_container?.getBoundingClientRect();
            
            if (rect && bbox) {
                // Calculate zoom-based scale for button
                const zoom = cy.zoom();
                const scale = Math.max(0.6, Math.min(1.2, zoom)); // Clamp between 0.6x and 1.2x
                const buttonSize = 28 * scale;
                
                // Position in top-right corner of the bounding box, mostly inside
                const left = rect.left + bbox.x2 - buttonSize * 0.9;
                const top = rect.top + bbox.y1 + buttonSize * 0.1;
                
                floatingBtn.style.left = `${left}px`;
                floatingBtn.style.top = `${top}px`;
                floatingBtn.style.width = `${buttonSize}px`;
                floatingBtn.style.height = `${buttonSize}px`;
                floatingBtn.style.fontSize = `${16 * scale}px`; // Scale icon size too
            }
        }
        
        function setSelectedNode(nodeId) {
            console.log('[setSelectedNode] Called with:', nodeId);
            selectedNodeId = nodeId || null;
            
            const floatingBtn = document.getElementById('floating-edit-btn');
            console.log('[setSelectedNode] Button element:', floatingBtn);
            
            // Remove previous selection styling
            if (cy) {
                cy.nodes().forEach(n => {
                    n.removeClass('selected');
                });
            }
            
            // Add selection styling and position floating button
            if (selectedNodeId && cy) {
                const node = cy.getElementById(selectedNodeId);
                console.log('[setSelectedNode] Found node:', node.id(), 'empty:', node.empty());
                if (node && !node.empty()) {
                    node.addClass('selected');
                    console.log('[setSelectedNode] Added selected class');
                    
                    // Position floating edit icon
                    if (floatingBtn) {
                        updateFloatingButtonPosition();
                        floatingBtn.style.display = 'flex';
                    } else {
                        console.error('[setSelectedNode] Button element not found!');
                    }
                }
            } else {
                console.log('[setSelectedNode] Hiding button');
                // Hide floating button when nothing selected
                if (floatingBtn) {
                    floatingBtn.style.display = 'none';
                }
            }
        }

        // Update version indicator display
        async function setVersionIndicator(versionNumber) {
            currentVersionNumber = versionNumber;
            const indicator = document.getElementById('version-indicator');
            const versionLabel = document.getElementById('version-number');
            const dateLabel = document.getElementById('version-date');
            const descLabel = document.getElementById('version-description');
            
            if (indicator && versionLabel) {
                versionLabel.textContent = `v${versionNumber}`;
                
                // Fetch version details to show date and description
                const graphIdInput = document.getElementById('graph-id-input');
                if (graphIdInput && graphIdInput.value) {
                    try {
                        const response = await fetch(`/api/graphs/${graphIdInput.value}/versions`);
                        const data = await response.json();
                        if (data.versions) {
                            const version = data.versions.find(v => v.version_number === versionNumber);
                            if (version) {
                                const date = new Date(version.created_at);
                                if (dateLabel) dateLabel.textContent = `â€¢ ${date.toLocaleDateString()}`;
                                if (descLabel) {
                                    const desc = version.instruction || '(no description)';
                                    descLabel.textContent = `â€¢ ${desc}`;
                                }
                            }
                        }
                    } catch (error) {
                        console.error('Error fetching version details:', error);
                    }
                }
                
                // Show edit button only if a specific version is displayed (not "Latest")
                const editBtn = document.getElementById('edit-version-btn');
                if (editBtn) {
                    editBtn.style.display = versionNumber ? 'inline-block' : 'none';
                    editBtn.onclick = (e) => {
                        e.stopPropagation();
                        toggleVersionDescriptionEdit(versionNumber);
                    };
                    // Reinitialize Lucide icons
                    if (typeof lucide !== 'undefined') {
                        lucide.createIcons();
                    }
                }
                
                indicator.style.display = 'inline-flex';
            }
        }

        // Toggle version description edit mode
        function toggleVersionDescriptionEdit(versionNumber) {
            const descLabel = document.getElementById('version-description');
            const indicator = document.getElementById('version-indicator');
            
            const existingInput = indicator.querySelector('input[data-version-edit]');
            if (existingInput) {
                existingInput.remove();
                descLabel.style.display = 'inline';
                return;
            }
            
            // Hide the description label and show input
            const currentDesc = descLabel.textContent.replace('â€¢ ', '');
            descLabel.style.display = 'none';
            
            const input = document.createElement('input');
            input.type = 'text';
            input.value = currentDesc === '(no description)' ? '' : currentDesc;
            input.setAttribute('data-version-edit', versionNumber);
            input.style.cssText = 'max-width: 150px; padding: 0.25rem 0.375rem; border: 1px solid var(--primary-blue); border-radius: 4px; font-size: 0.75rem;';
            
            input.addEventListener('blur', () => {
                saveVersionDescription(versionNumber, input.value);
                input.remove();
                descLabel.style.display = 'inline';
            });
            
            input.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    input.blur();
                }
            });
            
            indicator.insertBefore(input, indicator.querySelector('#edit-version-btn'));
            input.focus();
            input.select();
        }

        // Save version description
        async function saveVersionDescription(versionNumber, description) {
            const graphIdInput = document.getElementById('graph-id-input');
            if (!graphIdInput?.value) return;
            
            try {
                const response = await fetch(`/api/graphs/${graphIdInput.value}/versions/${versionNumber}/description`, {
                    method: 'PATCH',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ description: description })
                });
                
                const data = await response.json();
                if (data.success) {
                    // Update the display
                    const descLabel = document.getElementById('version-description');
                    const displayText = description.trim() || '(no description)';
                    descLabel.textContent = `â€¢ ${displayText}`;
                } else {
                    console.error('Failed to update version description:', data.error);
                    alert('Failed to update version description');
                }
            } catch (error) {
                console.error('Error saving version description:', error);
                alert('Error saving version description');
            }
        }

        // Clear version indicator (for new graphs)
        function clearVersionIndicator() {
            currentVersionNumber = null;
            const indicator = document.getElementById('version-indicator');
            if (indicator) {
                indicator.style.display = 'none';
            }
        }
        
        function syncGraphState() {
            // Capture current graph state with custom icons and positions before save
            if (!cy) return true;
            
            const nodesInput = document.getElementById('nodes-input');
            const edgesInput = document.getElementById('edges-input');
            
            const nodes = cy.nodes().map(node => ({
                id: node.data('id'),
                label: node.data('label'),
                imageUrl: node.data('imageUrl'),
                position: node.position()  // Include node position
            }));
            
            const edges = cy.edges().map(edge => ({
                source: edge.data('source'),
                target: edge.data('target')
            }));
            
            if (nodesInput) {
                nodesInput.value = JSON.stringify(nodes);
                console.log('[syncGraphState] Nodes to save:', nodes);
            }
            
            if (edgesInput) {
                edgesInput.value = JSON.stringify(edges);
            }
            
            return true; // Allow form submission to continue
        }
        
        // Save graph via AJAX without page redirect
        async function saveGraphAjax() {
            syncGraphState();
            
            const graphIdInput = document.getElementById('graph-id-input');
            const filenamInput = document.getElementById('filename-base-input');
            const instructionInput = document.getElementById('instruction-input');
            const nodesInput = document.getElementById('nodes-input');
            const edgesInput = document.getElementById('edges-input');
            
            const formData = new FormData();
            if (graphIdInput?.value) formData.append('graph_id', graphIdInput.value);
            if (filenamInput?.value) formData.append('filename_base', filenamInput.value);
            if (instructionInput?.value) formData.append('instruction', instructionInput.value);
            if (nodesInput?.value) formData.append('nodes', nodesInput.value);
            if (edgesInput?.value) formData.append('edges', edgesInput.value);
            
            try {
                const response = await fetch('/save-graph', {
                    method: 'POST',
                    body: formData
                });
                
                const data = await response.json();
                
                if (response.ok && data.success) {
                    // Update graph_id if this was a new save
                    if (data.graph_id && graphIdInput) {
                        graphIdInput.value = data.graph_id;
                    }
                    // Update version indicator immediately with the returned version number
                    if (data.version_number) {
                        setVersionIndicator(data.version_number);
                    }
                    addMessage('ai', 'âœ“ Graph saved successfully!');
                } else {
                    addMessage('ai', 'Error saving graph: ' + (data.error || 'Unknown error'));
                }
            } catch (error) {
                console.error('Save error:', error);
                addMessage('ai', 'Error saving graph: ' + error.message);
            }
        }
        
        // Removed populateNodeCustomizer: replaced by on-demand Node Inspector
        
        async function updateNodeSymbol(nodeId, symbolName) {
            const node = cy.getElementById(nodeId);
            if (!node || node.length === 0) return;
            
            // If empty string selected, revert to auto-matching
            if (!symbolName) {
                const style = await getNodeStyle(nodeId);
                if (style.backgroundImage) {
                    node.data('imageUrl', style.backgroundImage);
                }
                console.log('Reverted to auto symbol for', nodeId);
                return;
            }
            
            // Otherwise use the selected symbol
            const symbolPath = `/static/symbols/${symbolName}.png`;
            try {
                const response = await fetch(symbolPath, { method: 'HEAD' });
                if (response.ok) {
                    node.data('imageUrl', symbolPath);
                    console.log('Updated node symbol for', nodeId, 'to', symbolName);
                }
            } catch (err) {
                console.error('Failed to update symbol for', nodeId, ':', err);
            }
        }
        
        async function uploadCustomIcon(nodeId, inputElement) {
            const file = inputElement.files[0];
            if (!file) return;
            
            // Show loading indicator
            const parent = inputElement.parentElement;
            const originalHTML = parent.innerHTML;
            parent.innerHTML = 'Uploading...';
            
            try {
                const formData = new FormData();
                formData.append('file', file);
                
                const response = await fetch('/api/symbols/upload', {
                    method: 'POST',
                    body: formData
                });
                
                if (!response.ok) {
                    throw new Error('Upload failed');
                }
                
                const data = await response.json();
                
                if (data.success && data.path) {
                    // Update node with custom icon
                    const node = cy.getElementById(nodeId);
                    if (node && node.length > 0) {
                        node.data('imageUrl', data.path);
                        console.log('Custom icon uploaded and applied to', nodeId);
                    }
                    alert('Custom icon uploaded successfully!');
                } else {
                    throw new Error(data.error || 'Upload failed');
                }
            } catch (err) {
                console.error('Failed to upload custom icon:', err);
                alert('Failed to upload icon: ' + err.message);
            } finally {
                // Restore UI
                parent.innerHTML = originalHTML;
                // Rebind onchange after restore
                const restoredInput = parent.querySelector('input[type="file"]');
                if (restoredInput) {
                    restoredInput.onchange = (e) => uploadCustomIcon(nodeId, e.target);
                }
            }
        }
    </script>

    <!-- Help Modal -->
    <div id="help-modal" class="modal-overlay">
        <div class="modal-content">
            <div class="modal-header">
                <h2>How to Use</h2>
                <button onclick="closeHelpModal()" class="modal-close">&times;</button>
            </div>
            
            <div class="modal-body">
                <h3>Getting Started</h3>
                <p><strong>1. Describe Your System:</strong> Type a description of your process in the chat box (e.g., "pump feeds water through a heat exchanger to a storage tank")</p>
                
                <p><strong>2. Generate:</strong> Press Enter to send. The AI will create a diagram with nodes and connections based on your description.</p>
                
                <p><strong>3. Interact with the Diagram:</strong></p>
                <ul>
                    <li><strong>Navigate:</strong> Use the toolbar buttons to Fit, Center, Zoom In/Out</li>
                    <li><strong>Drag nodes</strong> to reposition them (positions are saved automatically)</li>
                    <li><strong>Click a node</strong> to open the Node Inspector and customize it</li>
                    <li><strong>Click blank space</strong> to deselect</li>
                </ul>
                
                <p><strong>4. Customize Nodes:</strong> The Node Inspector lets you:</p>
                <ul>
                    <li><strong>Edit labels</strong> to rename equipment</li>
                    <li><strong>Change symbols</strong> from 250+ available icons (or let AI auto-match)</li>
                    <li><strong>Upload custom icons</strong> for specialized equipment</li>
                </ul>
                
                <p><strong>5. Save:</strong> Click the Save button (ðŸ’¾ icon) to save your work. Your diagram, positions, and customizations are all preserved.</p>
                
                <h3>Symbol Library</h3>
                <p>Click the <strong>â—† Symbol Browser</strong> button in the header to explore the 250+ available P&ID symbols. You can:</p>
                <ul>
                    <li><strong>Search</strong> for symbols by name or category (pump, valve, heat exchanger, etc.)</li>
                    <li><strong>Preview</strong> symbols before using them in your diagram</li>
                    <li><strong>Learn</strong> what symbols are available for your process design</li>
                    <li>Manually assign symbols to nodes using the Node Inspector</li>
                </ul>
                
                <h3>Tips</h3>
                <ul>
                    <li>Use technical terms for better AI recognition (e.g., centrifugal pump, ball valve, shell-and-tube heat exchanger)</li>
                    <li>Describe connections clearly ("pump outlet connects to valve inlet")</li>
                    <li>Refine iteratively - chat with the AI to add, remove, or modify components</li>
                    <li>Node positions snap to a grid for clean alignment</li>
                    <li>All changes are saved automatically when you click Save</li>
                </ul>
            </div>
        </div>
    </div>

    <script>
        // Graph click handlers from graph_viewer.js
        window.onGraphNodeClick = function(nodeId) {
            setSelectedNode(nodeId);
        };
        window.onGraphBlankClick = function() {
            setSelectedNode(null);
        };

        function openHelpModal() {
            document.getElementById('help-modal').style.display = 'flex';
        }
        
        function closeHelpModal() {
            document.getElementById('help-modal').style.display = 'none';
        }
        
        // Setup help button when DOM is ready
        const helpBtn = document.getElementById('help-btn');
        if (helpBtn) {
            helpBtn.addEventListener('click', openHelpModal);
        }
        
        // Close modal when clicking outside of it
        const helpModal = document.getElementById('help-modal');
        if (helpModal) {
            helpModal.addEventListener('click', function(e) {
                if (e.target === this) {
                    closeHelpModal();
                }
            });
        }

        // Floating edit button - opens symbol library
        const floatingEditBtn = document.getElementById('floating-edit-btn');
        if (floatingEditBtn) {
            floatingEditBtn.addEventListener('click', () => {
                if (selectedNodeId) {
                    openSymbolBrowser();
                }
            });
        }

        // Upload from symbol library
        const symbolLibraryUpload = document.getElementById('symbol-library-upload');
        if (symbolLibraryUpload) {
            symbolLibraryUpload.addEventListener('change', (e) => {
                if (selectedNodeId) {
                    uploadCustomIcon(selectedNodeId, e.target);
                    closeSymbolBrowser();
                }
            });
        }

        // Graph control button event listeners
        const layoutBtn = document.getElementById('layout-btn');
        if (layoutBtn) {
            layoutBtn.addEventListener('click', () => {
                if (cy) {
                    cy.fit(50);
                }
            });
        }

        const centerBtn = document.getElementById('center-btn');
        if (centerBtn) {
            centerBtn.addEventListener('click', () => {
                if (cy) {
                    cy.center();
                }
            });
        }

        const zoomInBtn = document.getElementById('zoom-in-btn');
        if (zoomInBtn) {
            zoomInBtn.addEventListener('click', () => {
                if (cy) {
                    cy.zoom(cy.zoom() * 1.2);
                    cy.center();
                }
            });
        }

        const zoomOutBtn = document.getElementById('zoom-out-btn');
        if (zoomOutBtn) {
            zoomOutBtn.addEventListener('click', () => {
                if (cy) {
                    cy.zoom(cy.zoom() * 0.8);
                    cy.center();
                }
            });
        }

        // Export dropdown menu
        const exportBtn = document.getElementById('export-btn');
        const exportMenu = document.getElementById('export-menu');
        const exportPngOption = document.getElementById('export-png-option');
        const exportSvgOption = document.getElementById('export-svg-option');

        if (exportBtn && exportMenu) {
            exportBtn.addEventListener('click', (e) => {
                e.stopPropagation();
                exportMenu.style.display = exportMenu.style.display === 'none' ? 'block' : 'none';
                // Reinitialize lucide icons in the menu
                if (typeof lucide !== 'undefined') {
                    lucide.createIcons();
                }
            });

            // Close menu when clicking outside
            document.addEventListener('click', () => {
                exportMenu.style.display = 'none';
            });

            exportMenu.addEventListener('click', (e) => {
                e.stopPropagation();
            });
        }

        // Export PNG
        if (exportPngOption) {
            exportPngOption.addEventListener('click', () => {
                if (!cy) return;
                
                const pngBlob = cy.png({
                    output: 'blob',
                    full: true,
                    scale: 3,
                    bg: 'white'
                });
                
                const url = URL.createObjectURL(pngBlob);
                const a = document.createElement('a');
                a.href = url;
                a.download = 'pid-diagram.png';
                a.click();
                URL.revokeObjectURL(url);
                exportMenu.style.display = 'none';
            });

            // Hover effect
            exportPngOption.addEventListener('mouseenter', () => {
                exportPngOption.style.background = 'var(--neutral-100)';
            });
            exportPngOption.addEventListener('mouseleave', () => {
                exportPngOption.style.background = 'none';
            });
        }

        // Export SVG
        if (exportSvgOption) {
            exportSvgOption.addEventListener('click', () => {
                if (!cy) return;
                
                const svgContent = cy.svg({ full: true, scale: 1 });
                const blob = new Blob([svgContent], { type: 'image/svg+xml' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = 'pid-diagram.svg';
                a.click();
                URL.revokeObjectURL(url);
                exportMenu.style.display = 'none';
            });

            // Hover effect
            exportSvgOption.addEventListener('mouseenter', () => {
                exportSvgOption.style.background = 'var(--neutral-100)';
            });
            exportSvgOption.addEventListener('mouseleave', () => {
                exportSvgOption.style.background = 'none';
            });
        }

        // Symbol Browser Modal
        function openSymbolBrowser() {
            const modal = document.getElementById('symbol-browser-modal');
            if (modal) {
                modal.style.display = 'flex';
                document.body.style.overflow = 'hidden';
                const searchInput = document.getElementById('symbol-search');
                if (searchInput) searchInput.focus();
                // Load symbols and populate grid
                updateSymbolGrid('');
                // Hide floating edit button while modal is open
                const floatingBtn = document.getElementById('floating-edit-btn');
                if (floatingBtn) floatingBtn.style.display = 'none';
            }
            // Re-initialize Lucide icons in case they weren't rendered yet
            if (typeof lucide !== 'undefined') {
                setTimeout(() => lucide.createIcons(), 100);
            }
        }

        function closeSymbolBrowser() {
            const modal = document.getElementById('symbol-browser-modal');
            if (modal) {
                modal.style.display = 'none';
                document.body.style.overflow = 'auto';
                // Show floating edit button again if a node is selected
                if (selectedNodeId) {
                    const floatingBtn = document.getElementById('floating-edit-btn');
                    if (floatingBtn) floatingBtn.style.display = 'flex';
                }
            }
        }

        // Version History Functions
        function openVersionHistory() {
            const modal = document.getElementById('version-history-modal');
            const graphId = document.getElementById('graph-id-input')?.value;
            
            if (!graphId) {
                alert('Please save the graph first to view version history');
                return;
            }
            
            if (modal) {
                modal.style.display = 'flex';
                document.body.style.overflow = 'hidden';
                loadVersionHistory(graphId);
            }
        }

        function closeVersionHistory() {
            const modal = document.getElementById('version-history-modal');
            if (modal) {
                modal.style.display = 'none';
                document.body.style.overflow = 'auto';
            }
        }

        async function loadVersionHistory(graphId) {
            const versionList = document.getElementById('version-list');
            const loading = document.getElementById('version-loading');
            const empty = document.getElementById('version-empty');
            
            versionList.innerHTML = '';
            loading.style.display = 'block';
            empty.style.display = 'none';
            
            try {
                const response = await fetch(`/api/graphs/${graphId}/versions`);
                const data = await response.json();
                
                loading.style.display = 'none';
                
                if (!data.success || data.versions.length === 0) {
                    empty.style.display = 'block';
                    return;
                }
                
                data.versions.forEach((version) => {
                    const item = document.createElement('div');
                    const isCurrentVersion = currentVersionNumber === version.version_number;
                    item.className = 'version-item' + (isCurrentVersion ? ' current' : '');
                    
                    const date = new Date(version.created_at);
                    const timeAgo = getTimeAgo(date);
                    // Show the description that was saved with this version
                    const descriptionPreview = version.instruction ? version.instruction.substring(0, 80) : '(no description)';
                    
                    item.innerHTML = `
                        <div class="version-info">
                            <div class="version-number">v${version.version_number}${isCurrentVersion ? ' â€¢ Current' : ''}</div>
                            <div class="version-time">${timeAgo} â€¢ ${date.toLocaleDateString()}</div>
                            <div class="version-instruction">${descriptionPreview}</div>
                        </div>
                        ${!isCurrentVersion ? `<button onclick="restoreVersion(${graphId}, ${version.version_number})" style="border: none; background: none; cursor: pointer; padding: 0.5rem; color: var(--primary-blue);" title="Restore this version"><i data-lucide="folder-open" style="width: 18px; height: 18px;"></i></button>` : '<span style="padding: 0.5rem;"></span>'}
                    `;
                    
                    versionList.appendChild(item);
                });
                
                // Re-initialize lucide icons for newly added buttons
                if (typeof lucide !== 'undefined') {
                    lucide.createIcons();
                }
            } catch (error) {
                console.error('Error loading versions:', error);
                loading.style.display = 'none';
                empty.innerHTML = '<p>Error loading versions</p>';
                empty.style.display = 'block';
            }
        }

        async function restoreVersion(graphId, versionNumber) {
            try {
                const response = await fetch(`/api/graphs/${graphId}/versions/${versionNumber}/restore`, {
                    method: 'POST'
                });
                const data = await response.json();
                
                if (data.success) {
                    // Store version number so it shows correctly after reload
                    sessionStorage.setItem('loadedVersionNumber', versionNumber);
                    window.location.reload();
                }
            } catch (error) {
                console.error('Error restoring version:', error);
            }
        }

        function getTimeAgo(timestamp) {
            const now = new Date();
            const past = new Date(timestamp);
            const seconds = Math.floor((now - past) / 1000);
            
            if (seconds < 60) return 'Just now';
            if (seconds < 3600) return Math.floor(seconds / 60) + ' minutes ago';
            if (seconds < 86400) return Math.floor(seconds / 3600) + ' hours ago';
            if (seconds < 604800) return Math.floor(seconds / 86400) + ' days ago';
            return past.toLocaleDateString();
        }

        async function updateSymbolGrid(searchQuery) {
            // Ensure symbols are loaded
            if (!SYMBOLS_LOADED && ALL_SYMBOLS.length === 0) {
                console.log('Loading symbols...');
                await loadSymbols();
            }

            const grid = document.getElementById('symbol-grid');
            if (!grid) return;

            console.log('ALL_SYMBOLS length:', ALL_SYMBOLS.length);
            const query = searchQuery.toLowerCase().trim();
            let filtered = ALL_SYMBOLS;

            if (query) {
                filtered = ALL_SYMBOLS.filter(sym => {
                    const name = (sym.name || '').toLowerCase();
                    const category = (sym.category || '').toLowerCase();
                    return name.includes(query) || category.includes(query);
                });
            }

            grid.innerHTML = '';
            if (filtered.length === 0 && ALL_SYMBOLS.length === 0) {
                const noSymbols = document.createElement('div');
                noSymbols.style.cssText = 'grid-column: 1/-1; text-align: center; padding: 2rem; color: var(--neutral-500);';
                noSymbols.innerHTML = '<p>Loading symbols...</p>';
                grid.appendChild(noSymbols);
                return;
            }

            filtered.forEach(symbol => {
                const item = document.createElement('div');
                item.className = 'symbol-browser-item';
                const symbolPath = symbol.path || symbol.url || '';
                item.innerHTML = `
                    <div class="symbol-image">
                        <img src="${symbolPath}" alt="${symbol.name}" onerror="this.style.display='none'">
                    </div>
                    <div class="symbol-name">${symbol.name}</div>
                    <div class="symbol-category">${symbol.category || ''}</div>
                `;
                
                // Apply symbol to selected node when clicked
                item.addEventListener('click', () => {
                    if (selectedNodeId) {
                        const symbolName = symbol.name.toLowerCase().replace(/\s+/g, '_');
                        updateNodeSymbol(selectedNodeId, symbolName);
                        closeSymbolBrowser();
                    }
                });
                
                grid.appendChild(item);
            });

            const noResults = document.getElementById('symbol-no-results');
            if (noResults) {
                noResults.style.display = (filtered.length === 0 && ALL_SYMBOLS.length > 0) ? 'block' : 'none';
            }
        }

        document.addEventListener('DOMContentLoaded', function() {
            const modal = document.getElementById('symbol-browser-modal');
            if (modal) {
                modal.addEventListener('click', function(e) {
                    if (e.target === modal) {
                        closeSymbolBrowser();
                    }
                });
            }

            const searchInput = document.getElementById('symbol-search');
            if (searchInput) {
                searchInput.addEventListener('input', function() {
                    updateSymbolGrid(this.value);
                });
            }

            const symbolBrowserBtn = document.getElementById('symbol-browser-btn');
            if (symbolBrowserBtn) {
                symbolBrowserBtn.addEventListener('click', openSymbolBrowser);
            }

            const closeBrowserBtn = document.getElementById('close-browser-btn');
            if (closeBrowserBtn) {
                closeBrowserBtn.addEventListener('click', closeSymbolBrowser);
            }

            // Version History modal handlers
            const historyBtn = document.getElementById('history-btn');
            if (historyBtn) {
                historyBtn.addEventListener('click', openVersionHistory);
            }

            const closeHistoryBtn = document.getElementById('close-history-btn');
            if (closeHistoryBtn) {
                closeHistoryBtn.addEventListener('click', closeVersionHistory);
            }

            const versionModal = document.getElementById('version-history-modal');
            if (versionModal) {
                versionModal.addEventListener('click', function(e) {
                    if (e.target === versionModal) {
                        closeVersionHistory();
                    }
                });
            }

            // Re-initialize Lucide icons to render all icons
            setTimeout(() => {
                if (typeof lucide !== 'undefined') {
                    lucide.createIcons();
                }
            }, 200);
        });

        // Footer modal handlers
        function openPrivacyModal() {
            document.getElementById('privacy-modal').style.display = 'flex';
        }

        function closePrivacyModal() {
            document.getElementById('privacy-modal').style.display = 'none';
        }

        function openTermsModal() {
            document.getElementById('terms-modal').style.display = 'flex';
        }

        function closeTermsModal() {
            document.getElementById('terms-modal').style.display = 'none';
        }

        // Close modals when clicking outside
        document.getElementById('privacy-modal')?.addEventListener('click', (e) => {
            if (e.target.id === 'privacy-modal') closePrivacyModal();
        });

        document.getElementById('terms-modal')?.addEventListener('click', (e) => {
            if (e.target.id === 'terms-modal') closeTermsModal();
        });
    </script>

    <!-- Footer -->
    <footer style="padding: 0.75rem 2rem; border-top: 1px solid var(--neutral-200); background: white; text-align: center; color: var(--neutral-600); font-size: 0.8rem;">
        <div style="display: flex; align-items: center; justify-content: center; gap: 1.25rem; flex-wrap: wrap;">
            <div>Â© 2026 AI P&ID</div>
            <a href="mailto:lawrencemsheets@gmail.com" style="color: var(--primary-blue); text-decoration: none;">Contact</a>
            <a href="#" onclick="openPrivacyModal(); return false;" style="color: var(--primary-blue); text-decoration: none;">Privacy</a>
            <a href="#" onclick="openTermsModal(); return false;" style="color: var(--primary-blue); text-decoration: none;">Terms</a>
        </div>
    </footer>

    <!-- Privacy Modal -->
    <div id="privacy-modal" class="modal-overlay" style="display: none;">
        <div class="modal-content" style="max-width: 600px;">
            <div class="modal-header">
                <h2>Privacy Policy</h2>
                <button onclick="closePrivacyModal()" class="modal-close">&times;</button>
            </div>
            <div class="modal-body">
                <h3>Information We Collect</h3>
                <p>When you create an account, we collect your email address and authentication information. P&ID diagrams you create are stored in your account and associated with your email.</p>

                <h3>How We Use Your Information</h3>
                <p>Your data is used solely to provide and improve the AI P&ID Tool service. We do not sell, share, or use your diagrams for any purpose other than providing you access to them. AI-generated suggestions may be based on your input, but diagram data is not retained for model training without your explicit consent.</p>

                <h3>Data Security</h3>
                <p>We implement standard security measures to protect your diagrams. Authentication is handled securely through OAuth providers (Google and GitHub), so we never store your passwords. Your diagrams are encrypted in transit and at rest.</p>

                <h3>Contact</h3>
                <p>For privacy concerns, please contact us at <a href="mailto:lawrencemsheets@gmail.com" style="color: var(--primary-blue);">lawrencemsheets@gmail.com</a></p>
            </div>
        </div>
    </div>

    <!-- Terms Modal -->
    <div id="terms-modal" class="modal-overlay" style="display: none;">
        <div class="modal-content" style="max-width: 600px;">
            <div class="modal-header">
                <h2>Terms of Service</h2>
                <button onclick="closeTermsModal()" class="modal-close">&times;</button>
            </div>
            <div class="modal-body">
                <h3>Use License</h3>
                <p>You are granted a non-exclusive, non-transferable license to use the AI P&ID Tool for personal and professional use. You may not reverse engineer, decompile, or attempt to derive the underlying algorithms.</p>

                <h3>User Responsibilities</h3>
                <p>You agree to use the tool lawfully and not to create content that violates intellectual property rights, defames others, or is otherwise harmful. You are responsible for the diagrams you create and share.</p>

                <h3>Limitations of Liability</h3>
                <p>The AI P&ID Tool is provided "as is" without warranties of any kind. We are not liable for errors in AI-generated suggestions or any damages resulting from use of the tool. Users should review and validate all generated content before relying on it for critical engineering work.</p>

                <h3>Service Modifications</h3>
                <p>We reserve the right to modify, suspend, or discontinue the service at any time. We will provide notice of significant changes when possible.</p>

                <h3>Contact</h3>
                <p>Questions about these terms? Contact us at <a href="mailto:lawrencemsheets@gmail.com" style="color: var(--primary-blue);">lawrencemsheets@gmail.com</a></p>
            </div>
        </div>
    </div>
</body>
</html>